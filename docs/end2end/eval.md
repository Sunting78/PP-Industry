# 全流程指标评估

模型的检测AP,分割mIoU指标往往无法直观地评估一套工业质检解决方案，为了能够更好在项目中落地，我们提供了工业之间行业常用的过杀漏检指标的评估，包含图像级别过杀指标，图像级别漏失指标，以及实例缺陷级别的漏检指标。

同时，为了进一步分析优化指标，提供了对badcase的分析，并且支持后处理NG/OK判断的参数调整重新评测，无需重新加载检测/分割模型预测结果。

## 评估用法
```
python3 tools/end2end/eval.py --input_path ./dataset/MT_dataset/val.json --pred_path ./output_det/output.json --config ./configs/end2end/e2e_det.yml --rules_eval --image_root /ssd3/sunting/PP-Industry/ 
```

具体参数说明如下：

| 参数名          | 含义                                 | 默认值     |
| -------------  | ------------------------------------| --------- |
| `--config`     |  全流程配置文件                       |           |
| `--input`      |  待预测的图像路径 或单个图像文件         |           |
| `--output_dir` |  保存预测文件和可视化结果路径            |`./output/`|

## 输出结果和指标说明

过杀指标：
```
Eval INFO: OK Evaluation Result:
+----------+-------+-------+-------+-------+-------+-------+
|    OK    |  ALL  |   1   |   2   |   3   |   4   |   5   |
+----------+-------+-------+-------+-------+-------+-------+
|  Total   |  318  |  318  |  318  |  318  |  318  |  318  |
|    OK    |  295  |  305  |  311  |  316  |  318  |  314  |
|    NG    |   23  |   13  |   7   |   2   |   0   |   4   |
| Overkill | 7.23% | 4.09% | 2.20% | 0.63% | 0.00% | 1.26% |
+----------+-------+-------+-------+-------+-------+-------+
```

图像级别漏检指标结果：
```
Eval INFO: Result of Image-Level NG NG Evaluation:
+--------------+-------+----+----+--------+
| Image Level  | Total | NG | OK | Escape |
+--------------+-------+----+----+--------+
| Lucky Result |  132  | 93 | 39 | 29.55% |
+--------------+-------+----+----+--------+
```

实例级别漏检指标结果：
```
Eval INFO: Result of Instance-Level NG Evaluation:
+----------+--------+-------+--------+--------+-------+--------+
|    NG    |  ALL   |   1   |   2    |   3    |   4   |   5    |
+----------+--------+-------+--------+--------+-------+--------+
|  Total   |  151   |   39  |   41   |   24   |   13  |   34   |
|    NG    |  100   |   36  |   25   |   19   |   12  |   8    |
|    OK    |   51   |   3   |   16   |   5    |   1   |   26   |
|  Escape  | 33.77% | 7.69% | 39.02% | 20.83% | 7.69% | 76.47% |
+----------+--------+-------+--------+--------+-------+--------+
```

## badcase输出

badcase输出保存在`output_path`路径下，目录结构如下：

```
    output_path
    |
    |--overkill            # 过杀文件夹
    |  |--Break            # 预测出的过杀类别
    |  |  |--exp1_xxx.jpg  # 可视化的过杀图像
    |  |  |--exp1_xxx.png
    |  |  ...   
    |  |--Uneven           # 预测出的过杀类别
    |  |  |--exp1_xxx.jpg
    |  |  |--exp1_xxx.png
    |  ...
    |--escape              # 漏检文件夹
    |  |--image_level      # 图像级别漏检，图像没有任何预测结果
    |  |  |--exp1_xxx.jpg
    |  |  |--exp1_xxx.png
    |  |  ...   
    |  |--instance_level   # 实例级别漏检，图像上某个/多个缺陷漏检
    |  |  |--Break         # 漏检的真实缺陷类别
    |  |  |  |--exp1_xxx.jpg
    |  |  |  |--exp1_xxx.png
    |  |  |  ...
    |  |  |--Uneven         # 漏检的真实缺陷类别
    |  |  |  |--exp1_xxx.jpg
    |  |  |  |--exp1_xxx.png
    |  |  |  ...
    |  |  ...
```


## 后处理参数调整


## 其他
判断NG/OK： 






